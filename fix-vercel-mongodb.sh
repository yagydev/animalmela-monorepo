#!/bin/bash

# üöÄ Quick Fix for Vercel MongoDB Connection Issues
# This script helps fix the 503 error on kisaanmela.com

echo "üöÄ FIXING VERCEL MONGODB CONNECTION ISSUES"
echo "=========================================="
echo ""

echo "üìã Current Issue:"
echo "‚ùå https://www.kisaanmela.com/api/login returns 503 Service Unavailable"
echo "‚ùå Error: 'MongoDB not available. Use demo@kisaanmela.com/demo123...'"
echo ""

echo "üéØ SOLUTION OPTIONS:"
echo ""
echo "1. üöÄ QUICK FIX - Enable Demo Mode (Immediate)"
echo "   This will make the site work immediately with demo users"
echo ""
echo "2. üóÑÔ∏è FULL FIX - Set up MongoDB Atlas (Recommended)"
echo "   This will provide a real database for production"
echo ""
echo "3. üìã MANUAL SETUP - Step-by-step instructions"
echo "   This will guide you through the complete setup"
echo ""

read -p "Choose option (1/2/3): " choice

case $choice in
    1)
        echo ""
        echo "üöÄ QUICK FIX - ENABLE DEMO MODE"
        echo "==============================="
        echo ""
        echo "This will make your site work immediately with demo users."
        echo ""
        echo "Steps to follow:"
        echo ""
        echo "1. Go to Vercel Dashboard:"
        echo "   https://vercel.com/dashboard"
        echo ""
        echo "2. Find your kisaanmela project and click on it"
        echo ""
        echo "3. Go to Settings ‚Üí Environment Variables"
        echo ""
        echo "4. Add these environment variables:"
        echo "   MONGODB_URI = demo-mode"
        echo "   DATABASE_URL = demo-mode"
        echo "   JWT_SECRET = your-super-secure-jwt-secret-key"
        echo "   NODE_ENV = production"
        echo ""
        echo "5. Click 'Save' and then 'Redeploy'"
        echo ""
        echo "6. Test the login API:"
        echo "   curl -X POST https://www.kisaanmela.com/api/login \\"
        echo "        -H 'Content-Type: application/json' \\"
        echo "        -d '{\"email\":\"demo@kisaanmela.com\",\"password\":\"demo123\"}'"
        echo ""
        echo "‚úÖ After redeployment, these demo users will work:"
        echo "   ‚Ä¢ demo@kisaanmela.com / demo123 (farmer)"
        echo "   ‚Ä¢ admin@kisaanmela.com / admin123 (admin)"
        echo "   ‚Ä¢ buyer@kisaanmela.com / buyer123 (buyer)"
        echo "   ‚Ä¢ seller@kisaanmela.com / seller123 (seller)"
        ;;
        
    2)
        echo ""
        echo "üóÑÔ∏è FULL FIX - MONGODB ATLAS SETUP"
        echo "=================================="
        echo ""
        echo "This will set up a real MongoDB database for production."
        echo ""
        echo "Steps to follow:"
        echo ""
        echo "1. Create MongoDB Atlas Account:"
        echo "   ‚Ä¢ Go to https://www.mongodb.com/atlas"
        echo "   ‚Ä¢ Sign up for free account"
        echo "   ‚Ä¢ Create project 'Kisaan Mela'"
        echo ""
        echo "2. Create Database Cluster:"
        echo "   ‚Ä¢ Choose 'Build a Database'"
        echo "   ‚Ä¢ Select 'M0 Sandbox' (Free tier)"
        echo "   ‚Ä¢ Choose your region"
        echo "   ‚Ä¢ Create cluster (takes 1-3 minutes)"
        echo ""
        echo "3. Configure Database Access:"
        echo "   ‚Ä¢ Go to 'Database Access'"
        echo "   ‚Ä¢ Add new user: kisaanmela_user"
        echo "   ‚Ä¢ Generate secure password"
        echo "   ‚Ä¢ Set privileges: 'Read and write to any database'"
        echo ""
        echo "4. Configure Network Access:"
        echo "   ‚Ä¢ Go to 'Network Access'"
        echo "   ‚Ä¢ Add IP Address: 0.0.0.0/0 (Allow from anywhere)"
        echo ""
        echo "5. Get Connection String:"
        echo "   ‚Ä¢ Go to 'Clusters'"
        echo "   ‚Ä¢ Click 'Connect' ‚Üí 'Connect your application'"
        echo "   ‚Ä¢ Copy connection string"
        echo ""
        echo "6. Add to Vercel Environment Variables:"
        echo "   MONGODB_URI = mongodb+srv://kisaanmela_user:PASSWORD@cluster0.xxxxx.mongodb.net/kisaanmela_prod?retryWrites=true&w=majority"
        echo "   DATABASE_URL = mongodb+srv://kisaanmela_user:PASSWORD@cluster0.xxxxx.mongodb.net/kisaanmela_prod?retryWrites=true&w=majority"
        echo "   JWT_SECRET = your-super-secure-jwt-secret-key"
        echo "   NODE_ENV = production"
        echo ""
        echo "7. Redeploy your Vercel application"
        echo ""
        echo "‚úÖ After setup, you'll have a real database with persistent data!"
        ;;
        
    3)
        echo ""
        echo "üìã MANUAL SETUP - STEP-BY-STEP INSTRUCTIONS"
        echo "==========================================="
        echo ""
        echo "For detailed instructions, see:"
        echo "üìñ VERCEL_DEPLOYMENT_GUIDE.md"
        echo ""
        echo "This guide includes:"
        echo "‚Ä¢ Complete MongoDB Atlas setup"
        echo "‚Ä¢ Vercel environment variable configuration"
        echo "‚Ä¢ Troubleshooting steps"
        echo "‚Ä¢ Testing procedures"
        echo ""
        echo "Quick reference:"
        echo "‚Ä¢ MongoDB Atlas: https://www.mongodb.com/atlas"
        echo "‚Ä¢ Vercel Dashboard: https://vercel.com/dashboard"
        echo "‚Ä¢ Test API: https://www.kisaanmela.com/api/login"
        ;;
        
    *)
        echo "‚ùå Invalid choice. Please run the script again and choose 1, 2, or 3."
        exit 1
        ;;
esac

echo ""
echo "üîç TROUBLESHOOTING:"
echo "   If you still get 503 errors after setup:"
echo "   1. Check Vercel logs: Dashboard ‚Üí Project ‚Üí Functions ‚Üí View Logs"
echo "   2. Verify environment variables are set correctly"
echo "   3. Make sure you redeployed after adding environment variables"
echo "   4. Test with demo users first: demo@kisaanmela.com / demo123"
echo ""
echo "üìû NEED HELP?"
echo "   If you encounter issues:"
echo "   1. Check the VERCEL_DEPLOYMENT_GUIDE.md for detailed instructions"
echo "   2. Verify your MongoDB Atlas connection string"
echo "   3. Make sure Vercel environment variables are set"
echo "   4. Check Vercel deployment logs for errors"
echo ""
echo "‚úÖ Ready to fix your kisaanmela.com MongoDB connection!"
